name: Tests

on: [push, pull_request]

jobs:
  unit_testing:
    name: Unit testing
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.3.0
      with:
        cache: true

    - name: Flutter version
      run: flutter --version

    - name: Download pub dependencies
      run: flutter pub get

    - name: Run unit testing
      run: flutter test test/calculator_test.dart

  desktop_integration_testing:
    name: Desktop integration testing
    runs-on: ubuntu-latest
    needs: unit_testing
    timeout-minutes: 30
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.3.0
      with:
        cache: true

    - name: Enable linux build
      run: flutter config --enable-linux-desktop

    - name: Run integration testing
      run: |
        flutter pub get
        flutter test integration_test/large_display_test.dart -d linux

  mobile_integration_testing:
    name: Mobile integration testing
    runs-on: macos-latest
    needs: desktop_integration_testing
    timeout-minutes: 30
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install missing packages
      run: |
        sudo apt update -y
        sudo apt install -y clang cmake ninja-build pkg-config libgtk-3-dev

    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2.3.0
      with:
        cache: true

    - name: Setup the Android Emulator and run tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        script: |
          flutter pub get
          flutter test integration_test/small_display_test.dart

# Blocked by: https://github.com/flutter/flutter/issues/95837

#  integration_testing:
#    name: Integration testing
#    runs-on: ubuntu-latest
#    needs: unit_testing
#    timeout-minutes: 30
#    steps:
#    - name: Checkout
#      uses: actions/checkout@v2
#
#    - name: Setup Java
#      uses: actions/setup-java@v3
#      with:
#        distribution: 'zulu'
#        java-version: '11'
#
#    - name: Setup Flutter
#      uses: subosito/flutter-action@v2.3.0
#      with:
#        cache: true
#
#    - name: Setup the Android Emulator and run tests
#      uses: reactivecircus/android-emulator-runner@v2
#      with:
#        api-level: 29
#        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
#        script: |
#          flutter pub get
#          flutter test integration_test